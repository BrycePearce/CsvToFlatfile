import { readFile } from "fs/promises";
import { convertCsvToWorkbook, createFlatfile } from "../index.js";

import "dotenv/config.js";

// const loadCsvWithHeaders = async () => {
//     let importedCsv: string;
//     try {
//         importedCsv = await readFile("./testData/zillow.csv", 'utf8')
//     } catch {
//         throw new Error('Failed to load the CSV file.');
//     }

//     if (!importedCsv) return null;

//     const workbook = convertCsvToWorkbook({ csv: importedCsv, hasColumnHeaders: true, workbookName: 'Zillow', sheetName: 'coolSheet#1' });
//     console.log('workbook done', JSON.stringify(workbook));
//     const flatfile = await createFlatfile(workbook, process.env?.flatfile ?? '');
//     console.log('flatfileResp', flatfile)
// }

// const loadCsvWithoutHeaders = async () => {
//     let importedCsv: string;
//     try {
//         importedCsv = await readFile("./testData/example.csv", 'utf8')
//     } catch {
//         throw new Error('Failed to load the CSV file.');
//     }

//     if (!importedCsv) return null;

//     const parsedCsv = convertCsvToWorkbook({ csv: importedCsv, hasColumnHeaders: false, workbookName: 'TestData', sheetName: 'Sheet', columnHeaders: ['date', 'measurementTotal', 'measurement', 'product', 'name', 'deliveryPoint'], flatfileKey: process.env?.flatfile ?? '' })
//     console.log('parsedCsv', parsedCsv)
// }

const loadCsvWithAutoGeneratedHeaders = async () => {
    let importedCsv: string;
    try {
        importedCsv = await readFile("./testData/nile.csv", 'utf8')
    } catch {
        throw new Error('Failed to load the CSV file.');
    }

    if (!importedCsv) return null;
    const { workbook, recordData } = convertCsvToWorkbook({ csv: importedCsv, hasColumnHeaders: true, workbookName: 'TestData', sheetName: 'The Nile through time' });

    // todo: messages are being mapped to every record. The user should have to use recordData to create a messages obj that's the same length as records and map them individually
    // see notes
    const recordMessages = [
        {
            key: "year",
            type: "info",
            message: "This is an informational message about the 'year' field."
        },
        {
            key: "flood",
            type: "error",
            message: "This is a warning message about the 'flood' field."
        }
    ];

    const flatfile = await createFlatfile({ workbook, recordData, flatfileApiKey: process.env?.flatfile ?? '', messages: recordMessages });
    // console.log('flatfileResp', flatfile)
}

// const loadCsvWithCustomFieldTypes = async () => {
//     let importedCsv: string;
//     try {
//         importedCsv = await readFile("./testData/nile.csv", 'utf8')
//     } catch {
//         throw new Error('Failed to load the CSV file.');
//     }

//     if (!importedCsv) return null;

//     const parsedCsv = convertCsvToWorkbook({
//         csv: importedCsv,
//         hasColumnHeaders: true,
//         workbookName: 'TestData',
//         sheetName: 'Nile with basic field types',
//         flatfileKey: process.env?.flatfile ?? '',
//         fieldTypes: [{ type: "number" }, { type: "string" }]
//     });
//     console.log('parsedCsv', parsedCsv)
// }

// const loadCsvWithReferenceAndEnum = async () => {
//     let importedCsv: string;
//     try {
//         importedCsv = await readFile("./testData/nile.csv", 'utf8')
//     } catch {
//         throw new Error('Failed to load the CSV file.');
//     }

//     if (!importedCsv) return null;

//     const parsedCsv = convertCsvToWorkbook({
//         csv: importedCsv,
//         hasColumnHeaders: true,
//         workbookName: 'TestData',
//         sheetName: 'Nile with a reference and enum field type',
//         flatfileKey: process.env?.flatfile ?? '',
//         sheetAccess: ["add", "edit", "delete", "import"],
//         fieldTypes: [{
//             type: "reference",
//             config: {
//                 ref: "parents",
//                 key: "email",
//                 relationship: "has-one"
//             }
//         }, {
//             type: "enum",
//             config: {
//                 allow_custom: false,
//                 options: [{
//                     value: "active",
//                     label: "Active"
//                 }, {
//                     value: "inactive",
//                     label: "Disabled",
//                     color: "#ff0000",
//                     icon: "fa fa-ban",
//                     metadata: {
//                         foo: "bar"
//                     }
//                 }]
//             }
//         }]
//     });

//     return parsedCsv;
// }


// loadCsvWithHeaders()
// loadCsvWithoutHeaders()
loadCsvWithAutoGeneratedHeaders()
// loadCsvWithReference();
// loadCsvWithReferenceAndEnum();